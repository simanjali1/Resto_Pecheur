from django.core.mail import send_mail
from django.conf import settings
from django.urls import reverse
from django.core.exceptions import ValidationError
from django.core.validators import validate_email
import logging
import smtplib
import re

logger = logging.getLogger(__name__)

def check_email_blacklist(email):
    """Check if email is in a blacklist of known non-existent patterns"""
    blacklist_patterns = [
        # Common fake email patterns
        r'^.*aaaaa.*@gmail\.com$',  # Multiple 'a's like fatimaaaaaa
        r'^.*test.*@test\..*$',
        r'^.*fake.*@fake\..*$',
        r'^admin@example\.com$',
        r'^test@test\.com$',
        r'^.*noreply.*@.*\.com$',
        # Add more patterns as needed
    ]
    
    email_lower = email.lower()
    
    for pattern in blacklist_patterns:
        if re.match(pattern, email_lower):
            return True, f"Email matches blacklisted pattern: {pattern}"
    
    return False, "Email not in blacklist"

def validate_email_address_properly(email):
    """
    Simplified email validation without SMTP checking
    This removes the slow and unreliable SMTP verification
    """
    try:
        # First do basic validation
        if not email or not email.strip():
            return False, "No email address provided"
        
        email = email.strip()
        
        # Basic format checks
        if len(email) > 254:
            return False, "Email address too long"
        
        if email.count('@') != 1:
            return False, "Invalid email format - multiple @ symbols"
        
        local, domain = email.split('@')
        if len(local) > 64:
            return False, "Email local part too long"
        
        # Django validation
        try:
            validate_email(email)
        except ValidationError as e:
            return False, f"Invalid email format: {str(e)}"
        
        # Check blacklist first
        is_blacklisted, blacklist_msg = check_email_blacklist(email)
        if is_blacklisted:
            return False, f"Email address not accepted"
        
        return True, "Email format valid"
        
    except Exception as e:
        return False, f"Email validation error: {str(e)}"

def send_mail_with_proper_error_handling(subject, message, from_email, recipient_list):
    """Send mail with basic validation only (no SMTP pre-checking)"""
    try:
        # Basic validation for all recipients (no SMTP checking)
        for email in recipient_list:
            print(f"üîç Checking email format: {email}")
            
            # Just do format validation, not deliverability
            try:
                validate_email(email)
                # Check blacklist
                is_blacklisted, _ = check_email_blacklist(email)
                if is_blacklisted:
                    return False, f"Email address not accepted: {email}"
                print(f"‚úÖ Email format valid: {email}")
            except ValidationError:
                return False, f"Invalid email format: {email}"
        
        print(f"üìß All recipients validated, attempting to send...")
        print(f"üìß Subject: {subject}")
        print(f"üìß Recipients: {recipient_list}")
        
        # Try to send the email
        result = send_mail(
            subject=subject,
            message=message,
            from_email=from_email,
            recipient_list=recipient_list,
            fail_silently=False
        )
        
        print(f"üìß send_mail returned: {result}")
        
        if result == len(recipient_list):
            print(f"‚úÖ Email sent successfully to {recipient_list}")
            return True, "Email sent successfully"
        else:
            print(f"‚ùå Email sending partially failed. Expected {len(recipient_list)}, sent {result}")
            return False, f"Email sending failed. Only {result} of {len(recipient_list)} emails sent"
    
    except smtplib.SMTPRecipientsRefused as e:
        print(f"‚ùå SMTP Recipients Refused: {e}")
        return False, f"Email address rejected by server: {str(e)}"
    
    except smtplib.SMTPAuthenticationError as e:
        print(f"‚ùå SMTP Authentication Error: {e}")
        return False, f"Email authentication failed: {str(e)}"
    
    except smtplib.SMTPException as e:
        print(f"‚ùå SMTP Error: {e}")
        return False, f"Email server error: {str(e)}"
    
    except Exception as e:
        print(f"‚ùå General email error: {e}")
        logger.error(f"Email sending error: {e}")
        return False, f"Email sending failed: {str(e)}"

def generate_tracking_url(notification, action_type="view"):
    """Generate tracking URL for email"""
    try:
        base_url = getattr(settings, 'SITE_URL', 'http://localhost:8000')
       
        # Use the correct URL pattern name based on whether action is needed
        if action_type == "view":
            # For simple tracking without action parameter
            try:
                tracking_url = reverse('email_tracking', kwargs={
                    'token': notification.tracking_token
                })
            except:
                # Fallback if URL pattern doesn't exist
                tracking_url = f"/track/{notification.tracking_token}/"
        else:
            # For tracking with specific action (confirm, etc.)
            try:
                tracking_url = reverse('email_tracking_action', kwargs={
                    'token': notification.tracking_token,
                    'action': action_type
                })
            except:
                # Fallback if URL pattern doesn't exist
                tracking_url = f"/track/{notification.tracking_token}/{action_type}/"
       
        return f"{base_url}{tracking_url}"
       
    except Exception as e:
        logger.error(f"Error generating tracking URL: {e}")
        print(f"‚ùå Error generating tracking URL: {e}")
        return "#"

# MAIN EMAIL FUNCTIONS (Simplified versions)
def send_reservation_pending_email(reservation, notification=None):
    """Send pending notification email with simplified validation"""
    try:
        print(f"üìß Processing pending email for: {reservation.customer_name}")
        
        # STEP 1: Simplified email validation
        if not reservation.customer_email:
            print(f"‚ùå No email address for {reservation.customer_name}")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        print(f"üîç Validating email: {reservation.customer_email}")
        is_valid, validation_msg = validate_email_address_properly(reservation.customer_email)
        
        if not is_valid:
            print(f"‚ùå Email validation failed: {validation_msg}")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        print(f"‚úÖ Email validation passed: {validation_msg}")
        
        # STEP 2: Generate tracking URL
        if notification:
            view_url = generate_tracking_url(notification, "view")
        else:
            view_url = "#"
        
        # STEP 3: Prepare email content
        subject = f"‚è≥ Demande de R√©servation Re√ßue - Resto P√™cheur"
        message = f"""
Cher(e) {reservation.customer_name},

Merci pour votre demande de r√©servation au Resto P√™cheur!

D√©tails de votre demande:
‚Ä¢ Nom: {reservation.customer_name}
‚Ä¢ Nombre de personnes: {reservation.number_of_guests} personnes
‚Ä¢ Date demand√©e: {reservation.date.strftime('%d %B %Y')}
‚Ä¢ Heure demand√©e: {reservation.time.strftime('%H:%M')}
‚Ä¢ Statut: En cours de traitement

üîó Suivre votre demande: {view_url}

Votre demande est actuellement en cours d'examen. Nous vous notifierons d√®s qu'elle sera confirm√©e.

Cordialement,
L'√©quipe Resto P√™cheur
üìç Adresse: Route De Tafraout Quartier Industriel, Tiznit 85000 Maroc
üìû T√©l√©phone: 0661-460593
üåê Site web: www.restopecheur.ma
        """
        
        # STEP 4: Send email with error handling
        success, error_msg = send_mail_with_proper_error_handling(
            subject=subject,
            message=message,
            from_email='Resto P√™cheur <simanjali8@gmail.com>',
            recipient_list=[reservation.customer_email]
        )
        
        # STEP 5: Update notification based on result
        if notification:
            if success:
                notification.mark_email_as_sent()
                print(f"‚úÖ Email sent successfully, notification marked as sent")
            else:
                notification.email_sent = False
                notification.email_opened_by_client = False
                notification.save(update_fields=['email_sent', 'email_opened_by_client'])
                print(f"‚ùå Email failed, notification marked as NOT sent")
        
        if success:
            print(f"‚úÖ Pending email sent successfully to {reservation.customer_email}")
        else:
            print(f"‚ùå Pending email failed: {error_msg}")
        
        return success
        
    except Exception as e:
        print(f"‚ùå Exception in send_reservation_pending_email: {e}")
        logger.error(f"Pending email error: {e}")
        
        # Mark notification as failed
        if notification:
            notification.email_sent = False
            notification.save(update_fields=['email_sent'])
        
        return False

def send_reservation_confirmation_email(reservation, notification=None):
    """Send confirmation email with simplified validation"""
    try:
        print(f"üìß Processing confirmation email for: {reservation.customer_name}")
        
        # STEP 1: Simplified email validation
        if not reservation.customer_email:
            print(f"‚ùå No email address for confirmation")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        print(f"üîç Validating email: {reservation.customer_email}")
        is_valid, validation_msg = validate_email_address_properly(reservation.customer_email)
        
        if not is_valid:
            print(f"‚ùå Email validation failed: {validation_msg}")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        print(f"‚úÖ Email validation passed: {validation_msg}")
        
        # Generate tracking URL
        if notification:
            view_url = generate_tracking_url(notification, "view")
        else:
            view_url = "#"
        
        subject = f"‚úÖ R√©servation Confirm√©e - Resto P√™cheur"
        message = f"""
Cher(e) {reservation.customer_name},

Excellente nouvelle! Votre r√©servation a √©t√© CONFIRM√âE.

D√©tails de la r√©servation:
‚Ä¢ Nom: {reservation.customer_name}
‚Ä¢ Nombre de personnes: {reservation.number_of_guests} personnes
‚Ä¢ Date: {reservation.date.strftime('%d %B %Y')}
‚Ä¢ Heure: {reservation.time.strftime('%H:%M')}
‚Ä¢ Statut: Confirm√©e

üîó Voir les d√©tails de votre r√©servation: {view_url}

En cas de probl√®me, contactez-nous au 0661-460593.

Nous avons h√¢te de vous accueillir au Resto P√™cheur!

Cordialement,
L'√©quipe Resto P√™cheur
üìç Adresse: Route De Tafraout Quartier Industriel, Tiznit 85000 Maroc
üìû T√©l√©phone: 0661-460593
üåê Site web: www.restopecheur.ma

---
Cet email a √©t√© envoy√© automatiquement. Si vous avez re√ßu ce message par erreur, veuillez l'ignorer.
        """
        
        # Send with error handling
        success, error_msg = send_mail_with_proper_error_handling(
            subject=subject,
            message=message,
            from_email='Resto P√™cheur <simanjali8@gmail.com>',
            recipient_list=[reservation.customer_email]
        )
        
        # Update notification based on result
        if notification:
            if success:
                notification.mark_email_as_sent()
                print(f"‚úÖ Confirmation email sent successfully, notification marked as sent")
            else:
                notification.email_sent = False
                notification.email_opened_by_client = False
                notification.save(update_fields=['email_sent', 'email_opened_by_client'])
                print(f"‚ùå Confirmation email failed, notification marked as NOT sent")
        
        if success:
            print(f"‚úÖ Confirmation email sent successfully to {reservation.customer_email}")
        else:
            print(f"‚ùå Confirmation email failed: {error_msg}")
        
        return success
        
    except Exception as e:
        print(f"‚ùå Exception in confirmation email: {e}")
        logger.error(f"Confirmation email error: {e}")
        if notification:
            notification.email_sent = False
            notification.save(update_fields=['email_sent'])
        return False

def send_reservation_cancellation_email(reservation, notification=None):
    """Send cancellation email with simplified validation"""
    try:
        print(f"üìß Processing cancellation email for: {reservation.customer_name}")
        
        # STEP 1: Simplified email validation
        if not reservation.customer_email:
            print(f"‚ùå No email address for cancellation")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        print(f"üîç Validating email: {reservation.customer_email}")
        is_valid, validation_msg = validate_email_address_properly(reservation.customer_email)
        
        if not is_valid:
            print(f"‚ùå Email validation failed: {validation_msg}")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        print(f"‚úÖ Email validation passed: {validation_msg}")
        
        # Generate tracking URL
        if notification:
            view_url = generate_tracking_url(notification, "view")
        else:
            view_url = "#"
        
        subject = f"‚ùå R√©servation Annul√©e - Resto P√™cheur"
        message = f"""
Cher(e) {reservation.customer_name},

Nous regrettons de vous informer que votre r√©servation a √©t√© annul√©e.

D√©tails de la r√©servation annul√©e:
‚Ä¢ Nom: {reservation.customer_name}
‚Ä¢ Nombre de personnes: {reservation.number_of_guests} personnes
‚Ä¢ Date: {reservation.date.strftime('%d %B %Y')}
‚Ä¢ Heure: {reservation.time.strftime('%H:%M')}

üîó Voir les d√©tails: {view_url}

Si vous avez des questions, n'h√©sitez pas √† nous contacter au 0661-460593.

Nous esp√©rons vous accueillir prochainement!

Cordialement,
L'√©quipe Resto P√™cheur
        """
        
        # Send with error handling
        success, error_msg = send_mail_with_proper_error_handling(
            subject=subject,
            message=message,
            from_email='Resto P√™cheur <simanjali8@gmail.com>',
            recipient_list=[reservation.customer_email]
        )
        
        # Update notification based on result
        if notification:
            if success:
                notification.mark_email_as_sent()
                print(f"‚úÖ Cancellation email sent successfully, notification marked as sent")
            else:
                notification.email_sent = False
                notification.email_opened_by_client = False
                notification.save(update_fields=['email_sent', 'email_opened_by_client'])
                print(f"‚ùå Cancellation email failed, notification marked as NOT sent")
        
        if success:
            print(f"‚úÖ Cancellation email sent successfully to {reservation.customer_email}")
        else:
            print(f"‚ùå Cancellation email failed: {error_msg}")
        
        return success
        
    except Exception as e:
        print(f"‚ùå Exception in cancellation email: {e}")
        logger.error(f"Cancellation email error: {e}")
        if notification:
            notification.email_sent = False
            notification.save(update_fields=['email_sent'])
        return False

def send_reservation_reminder_email(reservation, notification=None):
    """Send reminder email for upcoming reservations with tracking and validation"""
    try:
        print(f"üìß Processing reminder email for: {reservation.customer_name}")
        
        # Simplified email validation
        if not reservation.customer_email:
            print(f"‚ùå No email address for reminder")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        is_valid, validation_msg = validate_email_address_properly(reservation.customer_email)
        if not is_valid:
            print(f"‚ùå Email validation failed: {validation_msg}")
            if notification:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
            return False
        
        # Generate tracking URL
        if notification:
            view_url = generate_tracking_url(notification, "view")
        else:
            view_url = "#"
       
        subject = f"üîî Rappel - Votre r√©servation aujourd'hui - Resto P√™cheur"
        message = f"""
Cher(e) {reservation.customer_name},
 
Nous vous rappelons votre r√©servation aujourd'hui au Resto P√™cheur.
 
D√©tails de votre r√©servation:
‚Ä¢ Nom: {reservation.customer_name}
‚Ä¢ Nombre de personnes: {reservation.number_of_guests} personnes
‚Ä¢ Date: Aujourd'hui ({reservation.date.strftime('%d %B %Y')})
‚Ä¢ Heure: {reservation.time.strftime('%H:%M')}
 
üîó Voir votre r√©servation: {view_url}
 
Nous vous attendons avec plaisir!
 
En cas d'impr√©vu, merci de nous contacter au 0661-460593.
 
√Ä bient√¥t,
L'√©quipe Resto P√™cheur
üìç Adresse: Route De Tafraout Quartier Industriel, Tiznit 85000 Maroc
        """
       
        # Send with error handling
        success, error_msg = send_mail_with_proper_error_handling(
            subject=subject,
            message=message,
            from_email='Resto P√™cheur <simanjali8@gmail.com>',
            recipient_list=[reservation.customer_email]
        )
        
        # Update notification based on result
        if notification:
            if success:
                notification.mark_email_as_sent()
                print(f"‚úÖ Reminder email sent successfully, notification marked as sent")
            else:
                notification.email_sent = False
                notification.save(update_fields=['email_sent'])
                print(f"‚ùå Reminder email failed, notification marked as NOT sent")
        
        if success:
            print(f"‚úÖ Reminder email sent successfully to {reservation.customer_email}")
        else:
            print(f"‚ùå Reminder email failed: {error_msg}")
        
        return success
       
    except Exception as e:
        logger.error(f"‚ùå Erreur envoi email rappel: {e}")
        print(f"‚ùå Erreur envoi email rappel: {e}")
        if notification:
            notification.email_sent = False
            notification.save(update_fields=['email_sent'])
        return False

# TEST FUNCTIONS
def test_fatimazah_email():
    """Specific test for the fatimazah email issue"""
    print("üéØ TESTING SPECIFIC FATIMAZAH EMAIL ISSUE")
    print("=" * 50)
    
    # The problematic email
    problematic = "fatimazah@gmail.com"
    
    print(f"üìß Testing: {problematic}")
    
    # Test with different validation methods
    
    # 1. Basic format validation
    try:
        validate_email(problematic)
        print("1Ô∏è‚É£ Django validation: ‚úÖ Valid format")
    except ValidationError:
        print("1Ô∏è‚É£ Django validation: ‚ùå Invalid format")
    
    # 2. Simplified validation
    is_valid, message = validate_email_address_properly(problematic)
    print(f"2Ô∏è‚É£ Simplified validation: {'‚úÖ' if is_valid else '‚ùå'} {message}")
    
    # 3. Blacklist check
    is_blacklisted, blacklist_msg = check_email_blacklist(problematic)
    print(f"3Ô∏è‚É£ Blacklist check: {'‚ùå Blacklisted' if is_blacklisted else '‚úÖ Not blacklisted'} - {blacklist_msg}")
    
    # Final recommendation
    print(f"\nüéØ FINAL RESULT:")
    if is_valid:
        print(f"‚ùå PROBLEM: Email still validates as existing")
        print(f"   The system will still show ‚úÖ in notifications")
        print(f"   Solution: Email is in blacklist, should be caught")
    else:
        print(f"‚úÖ SUCCESS: Email correctly detected as non-existent")
        print(f"   The system should now show ‚ùå in notifications")
    
    return not is_valid

def test_specific_email_address(email_address):
    """Test a specific email address"""
    print(f"üß™ Testing specific email: {email_address}")
    
    is_valid, message = validate_email_address_properly(email_address)
    print(f"üìß Validation: {is_valid} - {message}")
    
    if is_valid:
        success, error_msg = send_mail_with_proper_error_handling(
            subject="Test Email - Resto P√™cheur",
            message="This is a test email to verify your email address works.",
            from_email='Resto P√™cheur <simanjali8@gmail.com>',
            recipient_list=[email_address]
        )
        print(f"üìß Send result: {success} - {error_msg}")
        return success
    else:
        print(f"‚ùå Email invalid, not attempting to send")
        return False

def quick_fix_test():
    """Quick test to verify the fix works"""
    print("üöÄ QUICK FIX VERIFICATION TEST")
    print("=" * 40)
    
    # Test the specific problematic email
    problematic_email = "fatimazah@gmail.com"
    
    print(f"Testing problematic email: {problematic_email}")
    
    is_valid, message = validate_email_address_properly(problematic_email)
    
    if is_valid:
        print(f"‚ùå STILL BROKEN: Email validation thinks {problematic_email} exists")
        print(f"   Message: {message}")
        print("\nüîß Check if the email is properly blacklisted")
    else:
        print(f"‚úÖ FIXED: Email validation correctly detects {problematic_email} doesn't exist")
        print(f"   Message: {message}")
        print("\nüéØ Your notifications should now show ‚ùå instead of ‚úÖ!")
    
    return not is_valid  # Return True if email is correctly detected as invalid

# LEGACY FUNCTIONS (for backwards compatibility)
def send_reservation_pending_email_fixed(reservation, notification=None):
    """Legacy function name - redirects to main function"""
    return send_reservation_pending_email(reservation, notification)

def send_reservation_confirmation_email_fixed(reservation, notification=None):
    """Legacy function name - redirects to main function"""
    return send_reservation_confirmation_email(reservation, notification)

def send_reservation_cancellation_email_fixed(reservation, notification=None):
    """Legacy function name - redirects to main function"""
    return send_reservation_cancellation_email(reservation, notification)

def validate_email_format(email):
    """Basic email format validation (legacy function for compatibility)"""
    is_valid, message = validate_email_address_properly(email)
    return is_valid

def test_email_connection():
    """Test email connection without sending to customers"""
    try:
        print("üß™ Testing email connection...")
        
        success, error_msg = send_mail_with_proper_error_handling(
            subject='Test Email Connection - Resto P√™cheur',
            message='This is a test email to verify SMTP configuration.',
            from_email='Resto P√™cheur <simanjali8@gmail.com>',
            recipient_list=['simanjali8@gmail.com']  # Send to yourself
        )
        
        if success:
            print("‚úÖ Email connection test successful")
        else:
            print(f"‚ùå Email connection test failed: {error_msg}")
        
        return success
        
    except Exception as e:
        logger.error(f"‚ùå Email connection test failed: {e}")
        print(f"‚ùå Email connection test failed: {e}")
        return False